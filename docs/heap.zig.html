<style type="text/css" >
.more-decls {
    padding-left: 50px;
}
.anal-decl {
 background-color: #F7A41D77;
}
code {
 background-color: #F7A41D77;
}
</style><style type="text/css" >
pre > code {
  display: block;
  overflow: auto;
  padding: 0.5em;
  color: black;
}

details {
  margin-bottom: 0.5em;
  -webkit-touch-callout: none; /* iOS Safari */
    -webkit-user-select: none; /* Safari */
     -khtml-user-select: none; /* Konqueror HTML */
       -moz-user-select: none; /* Old versions of Firefox */
        -ms-user-select: none; /* Internet Explorer/Edge */
            user-select: none; /* Non-prefixed version, currently
                                  supported by Chrome, Edge, Opera and Firefox */
}

.tok {
  color: #333;
  font-style: normal;
}

.code {
  font-family: monospace;
  font-size: 0.8em;
}

.tok-kw {
  color: #333;
  font-weight: bold;
}

.tok-str {
  color: #d14;
}

.tok-builtin {
  color: #0086b3;
}

code.zig {
  color: #777;
  font-style: italic;
}

.tok-fn {
  color: #900;
  font-weight: bold;
}

.tok-null {
  color: #008080;
}

.tok-number {
  color: #008080;
}

.tok-type {
  color: #458;
  font-weight: bold;
}
</style><html><a href="https://github.com/ziglang/zig/blob/master/lib/std//heap.zig"><h1>/heap.zig</h1></a><div class="more-decls"></div><h2 style="color: orange;">types:</h2><div class="more-decls"><div class="anal-decl"><a href="https://github.com/ziglang/zig/blob/master/lib/std/heap.zig#L662">src</a><pre><code class="zig"><span class="tok tok-kw">pub</span> <span class="tok tok-kw">const</span> <span class="tok">FixedBufferAllocator</span> <span class="tok tok-symbol">=</span> <span class="tok tok-kw">struct</span></code></pre><details open><summary>fields:</summary><div class="md-fields more-decls"><div class="anal-decl"><a href="https://github.com/ziglang/zig/blob/master/lib/std/heap.zig#L663">src</a><pre><code class="zig"><span class="tok">allocator</span><span class="tok tok-symbol">:</span> <span class="tok">Allocator</span></code></pre></div><div class="anal-decl"><a href="https://github.com/ziglang/zig/blob/master/lib/std/heap.zig#L664">src</a><pre><code class="zig"><span class="tok">end_index</span><span class="tok tok-symbol">:</span> <span class="tok tok-type">usize</span></code></pre></div><div class="anal-decl"><a href="https://github.com/ziglang/zig/blob/master/lib/std/heap.zig#L665">src</a><pre><code class="zig"><span class="tok">buffer</span><span class="tok tok-symbol">:</span> <span class="tok tok-symbol">[</span><span class="tok tok-symbol">]</span><span class="tok tok-type">u8</span></code></pre></div></div></details><details><summary>funcs</summary><div class="md-funcs more-decls"><div class="anal-decl"><a href="https://github.com/ziglang/zig/blob/master/lib/std/heap.zig#L667">src</a><pre><code class="zig"><span class="tok tok-kw">fn</span> <span class="tok tok-fn">init</span><span class="tok tok-symbol">(</span><span class="tok">buffer</span><span class="tok tok-symbol">:</span> <span class="tok tok-symbol">[</span><span class="tok tok-symbol">]</span><span class="tok tok-type">u8</span><span class="tok tok-symbol">)</span> <span class="tok">FixedBufferAllocator</span></code></pre></div><div class="anal-decl"><a href="https://github.com/ziglang/zig/blob/master/lib/std/heap.zig#L678">src</a><pre><code class="zig"><span class="tok tok-kw">pub</span> <span class="tok tok-kw">fn</span> <span class="tok tok-fn">ownsPtr</span><span class="tok tok-symbol">(</span><span class="tok">self</span><span class="tok tok-symbol">:</span> <span class="tok tok-symbol">*</span><span class="tok">FixedBufferAllocator</span><span class="tok tok-symbol">,</span> <span class="tok">ptr</span><span class="tok tok-symbol">:</span> <span class="tok tok-symbol">[</span><span class="tok tok-symbol">*</span><span class="tok tok-symbol">]</span><span class="tok tok-type">u8</span><span class="tok tok-symbol">)</span> <span class="tok tok-type">bool</span> <span class="tok tok-symbol">{</span>
    <span class="tok tok-kw">return</span> <span class="tok">sliceContainsPtr</span><span class="tok tok-symbol">(</span><span class="tok">self</span><span class="tok tok-symbol">.</span><span class="tok">buffer</span><span class="tok tok-symbol">,</span> <span class="tok">ptr</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">;</span>
<span class="tok tok-symbol">}</span></code></pre></div><div class="anal-decl"><a href="https://github.com/ziglang/zig/blob/master/lib/std/heap.zig#L682">src</a><pre><code class="zig"><span class="tok tok-kw">pub</span> <span class="tok tok-kw">fn</span> <span class="tok tok-fn">ownsSlice</span><span class="tok tok-symbol">(</span><span class="tok">self</span><span class="tok tok-symbol">:</span> <span class="tok tok-symbol">*</span><span class="tok">FixedBufferAllocator</span><span class="tok tok-symbol">,</span> <span class="tok">slice</span><span class="tok tok-symbol">:</span> <span class="tok tok-symbol">[</span><span class="tok tok-symbol">]</span><span class="tok tok-type">u8</span><span class="tok tok-symbol">)</span> <span class="tok tok-type">bool</span> <span class="tok tok-symbol">{</span>
    <span class="tok tok-kw">return</span> <span class="tok">sliceContainsSlice</span><span class="tok tok-symbol">(</span><span class="tok">self</span><span class="tok tok-symbol">.</span><span class="tok">buffer</span><span class="tok tok-symbol">,</span> <span class="tok">slice</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">;</span>
<span class="tok tok-symbol">}</span></code></pre></div><div class="anal-decl"><b>NOTE: this will not work in all cases, if the last allocation had an adjusted_index
then we won't be able to determine what the last allocation was.  This is because
the alignForward operation done in alloc is not reverisible.
</b><a href="https://github.com/ziglang/zig/blob/master/lib/std/heap.zig#L689">src</a><pre><code class="zig"><span class="tok tok-kw">pub</span> <span class="tok tok-kw">fn</span> <span class="tok tok-fn">isLastAllocation</span><span class="tok tok-symbol">(</span><span class="tok">self</span><span class="tok tok-symbol">:</span> <span class="tok tok-symbol">*</span><span class="tok">FixedBufferAllocator</span><span class="tok tok-symbol">,</span> <span class="tok">buf</span><span class="tok tok-symbol">:</span> <span class="tok tok-symbol">[</span><span class="tok tok-symbol">]</span><span class="tok tok-type">u8</span><span class="tok tok-symbol">)</span> <span class="tok tok-type">bool</span> <span class="tok tok-symbol">{</span>
    <span class="tok tok-kw">return</span> <span class="tok">buf</span><span class="tok tok-symbol">.</span><span class="tok">ptr</span> <span class="tok tok-symbol">+</span> <span class="tok">buf</span><span class="tok tok-symbol">.</span><span class="tok">len</span> <span class="tok tok-symbol">==</span> <span class="tok">self</span><span class="tok tok-symbol">.</span><span class="tok">buffer</span><span class="tok tok-symbol">.</span><span class="tok">ptr</span> <span class="tok tok-symbol">+</span> <span class="tok">self</span><span class="tok tok-symbol">.</span><span class="tok">end_index</span><span class="tok tok-symbol">;</span>
<span class="tok tok-symbol">}</span></code></pre></div><div class="anal-decl"><a href="https://github.com/ziglang/zig/blob/master/lib/std/heap.zig#L738">src</a><pre><code class="zig"><span class="tok tok-kw">pub</span> <span class="tok tok-kw">fn</span> <span class="tok tok-fn">reset</span><span class="tok tok-symbol">(</span><span class="tok">self</span><span class="tok tok-symbol">:</span> <span class="tok tok-symbol">*</span><span class="tok">FixedBufferAllocator</span><span class="tok tok-symbol">)</span> <span class="tok tok-type">void</span> <span class="tok tok-symbol">{</span>
    <span class="tok">self</span><span class="tok tok-symbol">.</span><span class="tok">end_index</span> <span class="tok tok-symbol">=</span> <span class="tok tok-number">0</span><span class="tok tok-symbol">;</span>
<span class="tok tok-symbol">}</span></code></pre></div></div></details></div></div><h2 style="color: orange;">funcs:</h2><div class="more-decls"><div class="anal-decl"><b>Verifies that the adjusted length will still map to the full length
</b><a href="https://github.com/ziglang/zig/blob/master/lib/std/heap.zig#L220">src</a><pre><code class="zig"><span class="tok tok-kw">pub</span> <span class="tok tok-kw">fn</span> <span class="tok tok-fn">alignPageAllocLen</span><span class="tok tok-symbol">(</span><span class="tok">full_len</span><span class="tok tok-symbol">:</span> <span class="tok tok-type">usize</span><span class="tok tok-symbol">,</span> <span class="tok">len</span><span class="tok tok-symbol">:</span> <span class="tok tok-type">usize</span><span class="tok tok-symbol">,</span> <span class="tok">len_align</span><span class="tok tok-symbol">:</span> <span class="tok tok-type">u29</span><span class="tok tok-symbol">)</span> <span class="tok tok-type">usize</span> <span class="tok tok-symbol">{</span>
    <span class="tok tok-kw">const</span> <span class="tok">aligned_len</span> <span class="tok tok-symbol">=</span> <span class="tok">mem</span><span class="tok tok-symbol">.</span><span class="tok">alignAllocLen</span><span class="tok tok-symbol">(</span><span class="tok">full_len</span><span class="tok tok-symbol">,</span> <span class="tok">len</span><span class="tok tok-symbol">,</span> <span class="tok">len_align</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">;</span>
    <span class="tok">assert</span><span class="tok tok-symbol">(</span><span class="tok">mem</span><span class="tok tok-symbol">.</span><span class="tok">alignForward</span><span class="tok tok-symbol">(</span><span class="tok">aligned_len</span><span class="tok tok-symbol">,</span> <span class="tok">mem</span><span class="tok tok-symbol">.</span><span class="tok">page_size</span><span class="tok tok-symbol">)</span> <span class="tok tok-symbol">==</span> <span class="tok">full_len</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">;</span>
    <span class="tok tok-kw">return</span> <span class="tok">aligned_len</span><span class="tok tok-symbol">;</span>
<span class="tok tok-symbol">}</span></code></pre></div><div class="anal-decl"><a href="https://github.com/ziglang/zig/blob/master/lib/std/heap.zig#L786">src</a><pre><code class="zig"><span class="tok tok-kw">fn</span> <span class="tok tok-fn">stackFallback</span><span class="tok tok-symbol">(</span><span class="tok tok-kw">comptime</span> <span class="tok">size</span><span class="tok tok-symbol">:</span> <span class="tok tok-type">usize</span><span class="tok tok-symbol">,</span> <span class="tok">fallback_allocator</span><span class="tok tok-symbol">:</span> <span class="tok tok-symbol">*</span><span class="tok">Allocator</span><span class="tok tok-symbol">)</span> <span class="tok">StackFallbackAllocator</span><span class="tok tok-symbol">(</span><span class="tok">size</span><span class="tok tok-symbol">)</span></code></pre></div><div class="anal-decl"><a href="https://github.com/ziglang/zig/blob/master/lib/std/heap.zig#L798">src</a><pre><code class="zig"><span class="tok tok-kw">fn</span> <span class="tok tok-fn">StackFallbackAllocator</span><span class="tok tok-symbol">(</span><span class="tok tok-kw">comptime</span> <span class="tok">size</span><span class="tok tok-symbol">:</span> <span class="tok tok-type">usize</span><span class="tok tok-symbol">)</span> <span class="tok tok-type">type</span></code></pre><details open><summary>fields:</summary><div class="md-fields more-decls"><div class="anal-decl"><a href="https://github.com/ziglang/zig/blob/master/lib/std/heap.zig#L802">src</a><pre><code class="zig"><span class="tok">buffer</span><span class="tok tok-symbol">:</span> <span class="tok tok-symbol">[</span><span class="tok">size</span><span class="tok tok-symbol">]</span><span class="tok tok-type">u8</span></code></pre></div><div class="anal-decl"><a href="https://github.com/ziglang/zig/blob/master/lib/std/heap.zig#L803">src</a><pre><code class="zig"><span class="tok">allocator</span><span class="tok tok-symbol">:</span> <span class="tok">Allocator</span></code></pre></div><div class="anal-decl"><a href="https://github.com/ziglang/zig/blob/master/lib/std/heap.zig#L804">src</a><pre><code class="zig"><span class="tok">fallback_allocator</span><span class="tok tok-symbol">:</span> <span class="tok tok-symbol">*</span><span class="tok">Allocator</span></code></pre></div><div class="anal-decl"><a href="https://github.com/ziglang/zig/blob/master/lib/std/heap.zig#L805">src</a><pre><code class="zig"><span class="tok">fixed_buffer_allocator</span><span class="tok tok-symbol">:</span> <span class="tok">FixedBufferAllocator</span></code></pre></div></div></details><details><summary>funcs</summary><div class="md-funcs more-decls"><div class="anal-decl"><a href="https://github.com/ziglang/zig/blob/master/lib/std/heap.zig#L807">src</a><pre><code class="zig"><span class="tok tok-kw">pub</span> <span class="tok tok-kw">fn</span> <span class="tok tok-fn">get</span><span class="tok tok-symbol">(</span><span class="tok">self</span><span class="tok tok-symbol">:</span> <span class="tok tok-symbol">*</span><span class="tok">Self</span><span class="tok tok-symbol">)</span> <span class="tok tok-symbol">*</span><span class="tok">Allocator</span> <span class="tok tok-symbol">{</span>
    <span class="tok">self</span><span class="tok tok-symbol">.</span><span class="tok">fixed_buffer_allocator</span> <span class="tok tok-symbol">=</span> <span class="tok">FixedBufferAllocator</span><span class="tok tok-symbol">.</span><span class="tok">init</span><span class="tok tok-symbol">(</span><span class="tok">self</span><span class="tok tok-symbol">.</span><span class="tok">buffer</span><span class="tok tok-symbol">[</span><span class="tok tok-number">0</span><span class="tok tok-symbol">..</span><span class="tok tok-symbol">]</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">;</span>
    <span class="tok tok-kw">return</span> <span class="tok tok-symbol">&amp;</span><span class="tok">self</span><span class="tok tok-symbol">.</span><span class="tok">allocator</span><span class="tok tok-symbol">;</span>
<span class="tok tok-symbol">}</span></code></pre></div></div></details></div><div class="anal-decl"><b>This one should not try alignments that exceed what C malloc can handle.
</b><a href="https://github.com/ziglang/zig/blob/master/lib/std/heap.zig#L1022">src</a><pre><code class="zig"><span class="tok tok-kw">fn</span> <span class="tok tok-fn">testAllocator</span><span class="tok tok-symbol">(</span><span class="tok">base_allocator</span><span class="tok tok-symbol">:</span> <span class="tok tok-symbol">*</span><span class="tok">mem</span><span class="tok tok-symbol">.</span><span class="tok">Allocator</span><span class="tok tok-symbol">)</span> <span class="tok tok-symbol">!</span><span class="tok tok-type">void</span></code></pre></div><div class="anal-decl"><a href="https://github.com/ziglang/zig/blob/master/lib/std/heap.zig#L1068">src</a><pre><code class="zig"><span class="tok tok-kw">fn</span> <span class="tok tok-fn">testAllocatorAligned</span><span class="tok tok-symbol">(</span><span class="tok">base_allocator</span><span class="tok tok-symbol">:</span> <span class="tok tok-symbol">*</span><span class="tok">mem</span><span class="tok tok-symbol">.</span><span class="tok">Allocator</span><span class="tok tok-symbol">)</span> <span class="tok tok-symbol">!</span><span class="tok tok-type">void</span></code></pre></div><div class="anal-decl"><a href="https://github.com/ziglang/zig/blob/master/lib/std/heap.zig#L1098">src</a><pre><code class="zig"><span class="tok tok-kw">fn</span> <span class="tok tok-fn">testAllocatorLargeAlignment</span><span class="tok tok-symbol">(</span><span class="tok">base_allocator</span><span class="tok tok-symbol">:</span> <span class="tok tok-symbol">*</span><span class="tok">mem</span><span class="tok tok-symbol">.</span><span class="tok">Allocator</span><span class="tok tok-symbol">)</span> <span class="tok">mem</span><span class="tok tok-symbol">.</span><span class="tok">Allocator</span><span class="tok tok-symbol">.</span><span class="tok">Error</span><span class="tok tok-symbol">!</span><span class="tok tok-type">void</span></code></pre></div><div class="anal-decl"><a href="https://github.com/ziglang/zig/blob/master/lib/std/heap.zig#L1130">src</a><pre><code class="zig"><span class="tok tok-kw">fn</span> <span class="tok tok-fn">testAllocatorAlignedShrink</span><span class="tok tok-symbol">(</span><span class="tok">base_allocator</span><span class="tok tok-symbol">:</span> <span class="tok tok-symbol">*</span><span class="tok">mem</span><span class="tok tok-symbol">.</span><span class="tok">Allocator</span><span class="tok tok-symbol">)</span> <span class="tok">mem</span><span class="tok tok-symbol">.</span><span class="tok">Allocator</span><span class="tok tok-symbol">.</span><span class="tok">Error</span><span class="tok tok-symbol">!</span><span class="tok tok-type">void</span></code></pre></div></div><h2 style="color: orange;">values:</h2><div class="more-decls"><div class="anal-decl"><a href="https://github.com/ziglang/zig/blob/master/lib/std/heap.zig#L17">src</a><pre><code class="zig"><span class="tok tok-kw">const</span> <span class="tok">LoggingAllocator</span> <span class="tok tok-symbol">=</span> <span class="tok tok-builtin">@import</span><span class="tok tok-symbol">(</span><span class="tok tok-str">&quot;heap/logging_allocator.zig&quot;</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">.</span><span class="tok">LoggingAllocator</span></code></pre></div><div class="anal-decl"><a href="https://github.com/ziglang/zig/blob/master/lib/std/heap.zig#L18">src</a><pre><code class="zig"><span class="tok tok-kw">const</span> <span class="tok">loggingAllocator</span> <span class="tok tok-symbol">=</span> <span class="tok tok-builtin">@import</span><span class="tok tok-symbol">(</span><span class="tok tok-str">&quot;heap/logging_allocator.zig&quot;</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">.</span><span class="tok">loggingAllocator</span></code></pre></div><div class="anal-decl"><a href="https://github.com/ziglang/zig/blob/master/lib/std/heap.zig#L19">src</a><pre><code class="zig"><span class="tok tok-kw">const</span> <span class="tok">ArenaAllocator</span> <span class="tok tok-symbol">=</span> <span class="tok tok-builtin">@import</span><span class="tok tok-symbol">(</span><span class="tok tok-str">&quot;heap/arena_allocator.zig&quot;</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">.</span><span class="tok">ArenaAllocator</span></code></pre></div><div class="anal-decl"><a href="https://github.com/ziglang/zig/blob/master/lib/std/heap.zig#L20">src</a><pre><code class="zig"><span class="tok tok-kw">const</span> <span class="tok">GeneralPurposeAllocator</span> <span class="tok tok-symbol">=</span> <span class="tok tok-builtin">@import</span><span class="tok tok-symbol">(</span><span class="tok tok-str">&quot;heap/general_purpose_allocator.zig&quot;</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">.</span><span class="tok">GeneralPurposeAllocator</span></code></pre></div><div class="anal-decl"><b>Supports the full Allocator interface, including alignment, and exploiting
`malloc_usable_size` if available. For an allocator that directly calls
`malloc`/`free`, see `raw_c_allocator`.
</b><a href="https://github.com/ziglang/zig/blob/master/lib/std/heap.zig#L154">src</a><pre><code class="zig"><span class="tok tok-kw">const</span> <span class="tok">c_allocator</span> <span class="tok tok-symbol">=</span> <span class="tok tok-symbol">&amp;</span><span class="tok">c_allocator_state</span></code></pre></div><div class="anal-decl"><b>Asserts allocations are within `@alignOf(std.c.max_align_t)` and directly calls
`malloc`/`free`. Does not attempt to utilize `malloc_usable_size`.
This allocator is safe to use as the backing allocator with
`ArenaAllocator` for example and is more optimal in such a case
than `c_allocator`.
</b><a href="https://github.com/ziglang/zig/blob/master/lib/std/heap.zig#L165">src</a><pre><code class="zig"><span class="tok tok-kw">const</span> <span class="tok">raw_c_allocator</span> <span class="tok tok-symbol">=</span> <span class="tok tok-symbol">&amp;</span><span class="tok">raw_c_allocator_state</span></code></pre></div><div class="anal-decl"><b>This allocator makes a syscall directly for every allocation and free.
Thread-safe and lock-free.
</b><a href="https://github.com/ziglang/zig/blob/master/lib/std/heap.zig#L203">src</a><pre><code class="zig"><span class="tok tok-kw">const</span> <span class="tok">page_allocator</span> <span class="tok tok-symbol">=</span> <span class="tok tok-kw">if</span> <span class="tok tok-symbol">(</span><span class="tok">std</span><span class="tok tok-symbol">.</span><span class="tok">Target</span><span class="tok tok-symbol">.</span><span class="tok">current</span><span class="tok tok-symbol">.</span><span class="tok">isWasm</span><span class="tok tok-symbol">(</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">)</span>
    <span class="tok tok-symbol">&amp;</span><span class="tok">wasm_page_allocator_state</span>
<span class="tok tok-kw">else</span> <span class="tok tok-kw">if</span> <span class="tok tok-symbol">(</span><span class="tok">std</span><span class="tok tok-symbol">.</span><span class="tok">Target</span><span class="tok tok-symbol">.</span><span class="tok">current</span><span class="tok tok-symbol">.</span><span class="tok">os</span><span class="tok tok-symbol">.</span><span class="tok">tag</span> <span class="tok tok-symbol">==</span> <span class="tok tok-symbol">.</span><span class="tok">freestanding</span><span class="tok tok-symbol">)</span>
    <span class="tok">root</span><span class="tok tok-symbol">.</span><span class="tok">os</span><span class="tok tok-symbol">.</span><span class="tok">heap</span><span class="tok tok-symbol">.</span><span class="tok">page_allocator</span>
<span class="tok tok-kw">else</span>
    <span class="tok tok-symbol">&amp;</span><span class="tok">page_allocator_state</span></code></pre></div><div class="anal-decl"><b>TODO Utilize this on Windows.
</b><a href="https://github.com/ziglang/zig/blob/master/lib/std/heap.zig#L227">src</a><pre><code class="zig"><span class="tok tok-kw">var</span> <span class="tok">next_mmap_addr_hint</span><span class="tok tok-symbol">:</span> <span class="tok tok-symbol">?</span><span class="tok tok-symbol">[</span><span class="tok tok-symbol">*</span><span class="tok tok-symbol">]</span><span class="tok tok-kw">align</span><span class="tok tok-symbol">(</span><span class="tok">mem</span><span class="tok tok-symbol">.</span><span class="tok">page_size</span><span class="tok tok-symbol">)</span> <span class="tok tok-type">u8</span> <span class="tok tok-symbol">=</span> <span class="tok tok-null">null</span></code></pre></div><div class="anal-decl"><a href="https://github.com/ziglang/zig/blob/master/lib/std/heap.zig#L554">src</a><pre><code class="zig"><span class="tok tok-kw">const</span> <span class="tok">HeapAllocator</span> <span class="tok tok-symbol">=</span> <span class="tok tok-kw">switch</span> <span class="tok tok-symbol">(</span><span class="tok">builtin</span><span class="tok tok-symbol">.</span><span class="tok">os</span><span class="tok tok-symbol">.</span><span class="tok">tag</span><span class="tok tok-symbol">)</span> <span class="tok tok-symbol">{</span>
    <span class="tok tok-symbol">.</span><span class="tok">windows</span> <span class="tok tok-symbol">=&gt;</span> <span class="tok tok-kw">struct</span> <span class="tok tok-symbol">{</span>
        <span class="tok">allocator</span><span class="tok tok-symbol">:</span> <span class="tok">Allocator</span><span class="tok tok-symbol">,</span>
        <span class="tok">heap_handle</span><span class="tok tok-symbol">:</span> <span class="tok tok-symbol">?</span><span class="tok">HeapHandle</span><span class="tok tok-symbol">,</span>

        <span class="tok tok-kw">const</span> <span class="tok">HeapHandle</span> <span class="tok tok-symbol">=</span> <span class="tok">os</span><span class="tok tok-symbol">.</span><span class="tok">windows</span><span class="tok tok-symbol">.</span><span class="tok">HANDLE</span><span class="tok tok-symbol">;</span>

        <span class="tok tok-kw">pub</span> <span class="tok tok-kw">fn</span> <span class="tok tok-fn">init</span><span class="tok tok-symbol">(</span><span class="tok tok-symbol">)</span> <span class="tok">HeapAllocator</span> <span class="tok tok-symbol">{</span>
            <span class="tok tok-kw">return</span> <span class="tok">HeapAllocator</span><span class="tok tok-symbol">{</span>
                <span class="tok tok-symbol">.</span><span class="tok">allocator</span> <span class="tok tok-symbol">=</span> <span class="tok">Allocator</span><span class="tok tok-symbol">{</span>
                    <span class="tok tok-symbol">.</span><span class="tok">allocFn</span> <span class="tok tok-symbol">=</span> <span class="tok">alloc</span><span class="tok tok-symbol">,</span>
                    <span class="tok tok-symbol">.</span><span class="tok">resizeFn</span> <span class="tok tok-symbol">=</span> <span class="tok">resize</span><span class="tok tok-symbol">,</span>
                <span class="tok tok-symbol">}</span><span class="tok tok-symbol">,</span>
                <span class="tok tok-symbol">.</span><span class="tok">heap_handle</span> <span class="tok tok-symbol">=</span> <span class="tok tok-null">null</span><span class="tok tok-symbol">,</span>
            <span class="tok tok-symbol">}</span><span class="tok tok-symbol">;</span>
        <span class="tok tok-symbol">}</span>

        <span class="tok tok-kw">pub</span> <span class="tok tok-kw">fn</span> <span class="tok tok-fn">deinit</span><span class="tok tok-symbol">(</span><span class="tok">self</span><span class="tok tok-symbol">:</span> <span class="tok tok-symbol">*</span><span class="tok">HeapAllocator</span><span class="tok tok-symbol">)</span> <span class="tok tok-type">void</span> <span class="tok tok-symbol">{</span>
            <span class="tok tok-kw">if</span> <span class="tok tok-symbol">(</span><span class="tok">self</span><span class="tok tok-symbol">.</span><span class="tok">heap_handle</span><span class="tok tok-symbol">)</span> <span class="tok tok-symbol">|</span><span class="tok">heap_handle</span><span class="tok tok-symbol">|</span> <span class="tok tok-symbol">{</span>
                <span class="tok">os</span><span class="tok tok-symbol">.</span><span class="tok">windows</span><span class="tok tok-symbol">.</span><span class="tok">HeapDestroy</span><span class="tok tok-symbol">(</span><span class="tok">heap_handle</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">;</span>
            <span class="tok tok-symbol">}</span>
        <span class="tok tok-symbol">}</span>

        <span class="tok tok-kw">fn</span> <span class="tok tok-fn">getRecordPtr</span><span class="tok tok-symbol">(</span><span class="tok">buf</span><span class="tok tok-symbol">:</span> <span class="tok tok-symbol">[</span><span class="tok tok-symbol">]</span><span class="tok tok-type">u8</span><span class="tok tok-symbol">)</span> <span class="tok tok-symbol">*</span><span class="tok tok-kw">align</span><span class="tok tok-symbol">(</span><span class="tok tok-number">1</span><span class="tok tok-symbol">)</span> <span class="tok tok-type">usize</span> <span class="tok tok-symbol">{</span>
            <span class="tok tok-kw">return</span> <span class="tok tok-builtin">@intToPtr</span><span class="tok tok-symbol">(</span><span class="tok tok-symbol">*</span><span class="tok tok-kw">align</span><span class="tok tok-symbol">(</span><span class="tok tok-number">1</span><span class="tok tok-symbol">)</span> <span class="tok tok-type">usize</span><span class="tok tok-symbol">,</span> <span class="tok tok-builtin">@ptrToInt</span><span class="tok tok-symbol">(</span><span class="tok">buf</span><span class="tok tok-symbol">.</span><span class="tok">ptr</span><span class="tok tok-symbol">)</span> <span class="tok tok-symbol">+</span> <span class="tok">buf</span><span class="tok tok-symbol">.</span><span class="tok">len</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">;</span>
        <span class="tok tok-symbol">}</span>

        <span class="tok tok-kw">fn</span> <span class="tok tok-fn">alloc</span><span class="tok tok-symbol">(</span>
            <span class="tok">allocator</span><span class="tok tok-symbol">:</span> <span class="tok tok-symbol">*</span><span class="tok">Allocator</span><span class="tok tok-symbol">,</span>
            <span class="tok">n</span><span class="tok tok-symbol">:</span> <span class="tok tok-type">usize</span><span class="tok tok-symbol">,</span>
            <span class="tok">ptr_align</span><span class="tok tok-symbol">:</span> <span class="tok tok-type">u29</span><span class="tok tok-symbol">,</span>
            <span class="tok">len_align</span><span class="tok tok-symbol">:</span> <span class="tok tok-type">u29</span><span class="tok tok-symbol">,</span>
            <span class="tok">return_address</span><span class="tok tok-symbol">:</span> <span class="tok tok-type">usize</span><span class="tok tok-symbol">,</span>
        <span class="tok tok-symbol">)</span> <span class="tok tok-kw">error</span><span class="tok tok-symbol">{</span><span class="tok">OutOfMemory</span><span class="tok tok-symbol">}</span><span class="tok tok-symbol">!</span><span class="tok tok-symbol">[</span><span class="tok tok-symbol">]</span><span class="tok tok-type">u8</span> <span class="tok tok-symbol">{</span>
            <span class="tok tok-kw">const</span> <span class="tok">self</span> <span class="tok tok-symbol">=</span> <span class="tok tok-builtin">@fieldParentPtr</span><span class="tok tok-symbol">(</span><span class="tok">HeapAllocator</span><span class="tok tok-symbol">,</span> <span class="tok tok-str">&quot;allocator&quot;</span><span class="tok tok-symbol">,</span> <span class="tok">allocator</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">;</span>

            <span class="tok tok-kw">const</span> <span class="tok">amt</span> <span class="tok tok-symbol">=</span> <span class="tok">n</span> <span class="tok tok-symbol">+</span> <span class="tok">ptr_align</span> <span class="tok tok-symbol">-</span> <span class="tok tok-number">1</span> <span class="tok tok-symbol">+</span> <span class="tok tok-builtin">@sizeOf</span><span class="tok tok-symbol">(</span><span class="tok tok-type">usize</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">;</span>
            <span class="tok tok-kw">const</span> <span class="tok">optional_heap_handle</span> <span class="tok tok-symbol">=</span> <span class="tok tok-builtin">@atomicLoad</span><span class="tok tok-symbol">(</span><span class="tok tok-symbol">?</span><span class="tok">HeapHandle</span><span class="tok tok-symbol">,</span> <span class="tok tok-symbol">&amp;</span><span class="tok">self</span><span class="tok tok-symbol">.</span><span class="tok">heap_handle</span><span class="tok tok-symbol">,</span> <span class="tok">builtin</span><span class="tok tok-symbol">.</span><span class="tok">AtomicOrder</span><span class="tok tok-symbol">.</span><span class="tok">SeqCst</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">;</span>
            <span class="tok tok-kw">const</span> <span class="tok">heap_handle</span> <span class="tok tok-symbol">=</span> <span class="tok">optional_heap_handle</span> <span class="tok tok-kw">orelse</span> <span class="tok">blk</span><span class="tok tok-symbol">:</span> <span class="tok tok-symbol">{</span>
                <span class="tok tok-kw">const</span> <span class="tok">options</span> <span class="tok tok-symbol">=</span> <span class="tok tok-kw">if</span> <span class="tok tok-symbol">(</span><span class="tok">builtin</span><span class="tok tok-symbol">.</span><span class="tok">single_threaded</span><span class="tok tok-symbol">)</span> <span class="tok">os</span><span class="tok tok-symbol">.</span><span class="tok">windows</span><span class="tok tok-symbol">.</span><span class="tok">HEAP_NO_SERIALIZE</span> <span class="tok tok-kw">else</span> <span class="tok tok-number">0</span><span class="tok tok-symbol">;</span>
                <span class="tok tok-kw">const</span> <span class="tok">hh</span> <span class="tok tok-symbol">=</span> <span class="tok">os</span><span class="tok tok-symbol">.</span><span class="tok">windows</span><span class="tok tok-symbol">.</span><span class="tok">kernel32</span><span class="tok tok-symbol">.</span><span class="tok">HeapCreate</span><span class="tok tok-symbol">(</span><span class="tok">options</span><span class="tok tok-symbol">,</span> <span class="tok">amt</span><span class="tok tok-symbol">,</span> <span class="tok tok-number">0</span><span class="tok tok-symbol">)</span> <span class="tok tok-kw">orelse</span> <span class="tok tok-kw">return</span> <span class="tok tok-kw">error</span><span class="tok tok-symbol">.</span><span class="tok">OutOfMemory</span><span class="tok tok-symbol">;</span>
                <span class="tok tok-kw">const</span> <span class="tok">other_hh</span> <span class="tok tok-symbol">=</span> <span class="tok tok-builtin">@cmpxchgStrong</span><span class="tok tok-symbol">(</span><span class="tok tok-symbol">?</span><span class="tok">HeapHandle</span><span class="tok tok-symbol">,</span> <span class="tok tok-symbol">&amp;</span><span class="tok">self</span><span class="tok tok-symbol">.</span><span class="tok">heap_handle</span><span class="tok tok-symbol">,</span> <span class="tok tok-null">null</span><span class="tok tok-symbol">,</span> <span class="tok">hh</span><span class="tok tok-symbol">,</span> <span class="tok">builtin</span><span class="tok tok-symbol">.</span><span class="tok">AtomicOrder</span><span class="tok tok-symbol">.</span><span class="tok">SeqCst</span><span class="tok tok-symbol">,</span> <span class="tok">builtin</span><span class="tok tok-symbol">.</span><span class="tok">AtomicOrder</span><span class="tok tok-symbol">.</span><span class="tok">SeqCst</span><span class="tok tok-symbol">)</span> <span class="tok tok-kw">orelse</span> <span class="tok tok-kw">break</span> <span class="tok tok-symbol">:</span><span class="tok">blk</span> <span class="tok">hh</span><span class="tok tok-symbol">;</span>
                <span class="tok">os</span><span class="tok tok-symbol">.</span><span class="tok">windows</span><span class="tok tok-symbol">.</span><span class="tok">HeapDestroy</span><span class="tok tok-symbol">(</span><span class="tok">hh</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">;</span>
                <span class="tok tok-kw">break</span> <span class="tok tok-symbol">:</span><span class="tok">blk</span> <span class="tok">other_hh</span><span class="tok tok-symbol">.</span><span class="tok tok-symbol">?</span><span class="tok tok-symbol">;</span> // can't be null because of the cmpxchg
            <span class="tok tok-symbol">}</span><span class="tok tok-symbol">;</span>
            <span class="tok tok-kw">const</span> <span class="tok">ptr</span> <span class="tok tok-symbol">=</span> <span class="tok">os</span><span class="tok tok-symbol">.</span><span class="tok">windows</span><span class="tok tok-symbol">.</span><span class="tok">kernel32</span><span class="tok tok-symbol">.</span><span class="tok">HeapAlloc</span><span class="tok tok-symbol">(</span><span class="tok">heap_handle</span><span class="tok tok-symbol">,</span> <span class="tok tok-number">0</span><span class="tok tok-symbol">,</span> <span class="tok">amt</span><span class="tok tok-symbol">)</span> <span class="tok tok-kw">orelse</span> <span class="tok tok-kw">return</span> <span class="tok tok-kw">error</span><span class="tok tok-symbol">.</span><span class="tok">OutOfMemory</span><span class="tok tok-symbol">;</span>
            <span class="tok tok-kw">const</span> <span class="tok">root_addr</span> <span class="tok tok-symbol">=</span> <span class="tok tok-builtin">@ptrToInt</span><span class="tok tok-symbol">(</span><span class="tok">ptr</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">;</span>
            <span class="tok tok-kw">const</span> <span class="tok">aligned_addr</span> <span class="tok tok-symbol">=</span> <span class="tok">mem</span><span class="tok tok-symbol">.</span><span class="tok">alignForward</span><span class="tok tok-symbol">(</span><span class="tok">root_addr</span><span class="tok tok-symbol">,</span> <span class="tok">ptr_align</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">;</span>
            <span class="tok tok-kw">const</span> <span class="tok">return_len</span> <span class="tok tok-symbol">=</span> <span class="tok">init</span><span class="tok tok-symbol">:</span> <span class="tok tok-symbol">{</span>
                <span class="tok tok-kw">if</span> <span class="tok tok-symbol">(</span><span class="tok">len_align</span> <span class="tok tok-symbol">==</span> <span class="tok tok-number">0</span><span class="tok tok-symbol">)</span> <span class="tok tok-kw">break</span> <span class="tok tok-symbol">:</span><span class="tok">init</span> <span class="tok">n</span><span class="tok tok-symbol">;</span>
                <span class="tok tok-kw">const</span> <span class="tok">full_len</span> <span class="tok tok-symbol">=</span> <span class="tok">os</span><span class="tok tok-symbol">.</span><span class="tok">windows</span><span class="tok tok-symbol">.</span><span class="tok">kernel32</span><span class="tok tok-symbol">.</span><span class="tok">HeapSize</span><span class="tok tok-symbol">(</span><span class="tok">heap_handle</span><span class="tok tok-symbol">,</span> <span class="tok tok-number">0</span><span class="tok tok-symbol">,</span> <span class="tok">ptr</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">;</span>
                <span class="tok">assert</span><span class="tok tok-symbol">(</span><span class="tok">full_len</span> <span class="tok tok-symbol">!=</span> <span class="tok">std</span><span class="tok tok-symbol">.</span><span class="tok">math</span><span class="tok tok-symbol">.</span><span class="tok">maxInt</span><span class="tok tok-symbol">(</span><span class="tok tok-type">usize</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">;</span>
                <span class="tok">assert</span><span class="tok tok-symbol">(</span><span class="tok">full_len</span> <span class="tok tok-symbol">&gt;=</span> <span class="tok">amt</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">;</span>
                <span class="tok tok-kw">break</span> <span class="tok tok-symbol">:</span><span class="tok">init</span> <span class="tok">mem</span><span class="tok tok-symbol">.</span><span class="tok">alignBackwardAnyAlign</span><span class="tok tok-symbol">(</span><span class="tok">full_len</span> <span class="tok tok-symbol">-</span> <span class="tok tok-symbol">(</span><span class="tok">aligned_addr</span> <span class="tok tok-symbol">-</span> <span class="tok">root_addr</span><span class="tok tok-symbol">)</span> <span class="tok tok-symbol">-</span> <span class="tok tok-builtin">@sizeOf</span><span class="tok tok-symbol">(</span><span class="tok tok-type">usize</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">,</span> <span class="tok">len_align</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">;</span>
            <span class="tok tok-symbol">}</span><span class="tok tok-symbol">;</span>
            <span class="tok tok-kw">const</span> <span class="tok">buf</span> <span class="tok tok-symbol">=</span> <span class="tok tok-builtin">@intToPtr</span><span class="tok tok-symbol">(</span><span class="tok tok-symbol">[</span><span class="tok tok-symbol">*</span><span class="tok tok-symbol">]</span><span class="tok tok-type">u8</span><span class="tok tok-symbol">,</span> <span class="tok">aligned_addr</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">[</span><span class="tok tok-number">0</span><span class="tok tok-symbol">..</span><span class="tok">return_len</span><span class="tok tok-symbol">]</span><span class="tok tok-symbol">;</span>
            <span class="tok">getRecordPtr</span><span class="tok tok-symbol">(</span><span class="tok">buf</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">.*</span> <span class="tok tok-symbol">=</span> <span class="tok">root_addr</span><span class="tok tok-symbol">;</span>
            <span class="tok tok-kw">return</span> <span class="tok">buf</span><span class="tok tok-symbol">;</span>
        <span class="tok tok-symbol">}</span>

        <span class="tok tok-kw">fn</span> <span class="tok tok-fn">resize</span><span class="tok tok-symbol">(</span>
            <span class="tok">allocator</span><span class="tok tok-symbol">:</span> <span class="tok tok-symbol">*</span><span class="tok">Allocator</span><span class="tok tok-symbol">,</span>
            <span class="tok">buf</span><span class="tok tok-symbol">:</span> <span class="tok tok-symbol">[</span><span class="tok tok-symbol">]</span><span class="tok tok-type">u8</span><span class="tok tok-symbol">,</span>
            <span class="tok">buf_align</span><span class="tok tok-symbol">:</span> <span class="tok tok-type">u29</span><span class="tok tok-symbol">,</span>
            <span class="tok">new_size</span><span class="tok tok-symbol">:</span> <span class="tok tok-type">usize</span><span class="tok tok-symbol">,</span>
            <span class="tok">len_align</span><span class="tok tok-symbol">:</span> <span class="tok tok-type">u29</span><span class="tok tok-symbol">,</span>
            <span class="tok">return_address</span><span class="tok tok-symbol">:</span> <span class="tok tok-type">usize</span><span class="tok tok-symbol">,</span>
        <span class="tok tok-symbol">)</span> <span class="tok tok-kw">error</span><span class="tok tok-symbol">{</span><span class="tok">OutOfMemory</span><span class="tok tok-symbol">}</span><span class="tok tok-symbol">!</span><span class="tok tok-type">usize</span> <span class="tok tok-symbol">{</span>
            <span class="tok tok-kw">const</span> <span class="tok">self</span> <span class="tok tok-symbol">=</span> <span class="tok tok-builtin">@fieldParentPtr</span><span class="tok tok-symbol">(</span><span class="tok">HeapAllocator</span><span class="tok tok-symbol">,</span> <span class="tok tok-str">&quot;allocator&quot;</span><span class="tok tok-symbol">,</span> <span class="tok">allocator</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">;</span>
            <span class="tok tok-kw">if</span> <span class="tok tok-symbol">(</span><span class="tok">new_size</span> <span class="tok tok-symbol">==</span> <span class="tok tok-number">0</span><span class="tok tok-symbol">)</span> <span class="tok tok-symbol">{</span>
                <span class="tok">os</span><span class="tok tok-symbol">.</span><span class="tok">windows</span><span class="tok tok-symbol">.</span><span class="tok">HeapFree</span><span class="tok tok-symbol">(</span><span class="tok">self</span><span class="tok tok-symbol">.</span><span class="tok">heap_handle</span><span class="tok tok-symbol">.</span><span class="tok tok-symbol">?</span><span class="tok tok-symbol">,</span> <span class="tok tok-number">0</span><span class="tok tok-symbol">,</span> <span class="tok tok-builtin">@intToPtr</span><span class="tok tok-symbol">(</span><span class="tok tok-symbol">*</span><span class="tok tok-type">c_void</span><span class="tok tok-symbol">,</span> <span class="tok">getRecordPtr</span><span class="tok tok-symbol">(</span><span class="tok">buf</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">.*</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">;</span>
                <span class="tok tok-kw">return</span> <span class="tok tok-number">0</span><span class="tok tok-symbol">;</span>
            <span class="tok tok-symbol">}</span>

            <span class="tok tok-kw">const</span> <span class="tok">root_addr</span> <span class="tok tok-symbol">=</span> <span class="tok">getRecordPtr</span><span class="tok tok-symbol">(</span><span class="tok">buf</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">.*</span><span class="tok tok-symbol">;</span>
            <span class="tok tok-kw">const</span> <span class="tok">align_offset</span> <span class="tok tok-symbol">=</span> <span class="tok tok-builtin">@ptrToInt</span><span class="tok tok-symbol">(</span><span class="tok">buf</span><span class="tok tok-symbol">.</span><span class="tok">ptr</span><span class="tok tok-symbol">)</span> <span class="tok tok-symbol">-</span> <span class="tok">root_addr</span><span class="tok tok-symbol">;</span>
            <span class="tok tok-kw">const</span> <span class="tok">amt</span> <span class="tok tok-symbol">=</span> <span class="tok">align_offset</span> <span class="tok tok-symbol">+</span> <span class="tok">new_size</span> <span class="tok tok-symbol">+</span> <span class="tok tok-builtin">@sizeOf</span><span class="tok tok-symbol">(</span><span class="tok tok-type">usize</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">;</span>
            <span class="tok tok-kw">const</span> <span class="tok">new_ptr</span> <span class="tok tok-symbol">=</span> <span class="tok">os</span><span class="tok tok-symbol">.</span><span class="tok">windows</span><span class="tok tok-symbol">.</span><span class="tok">kernel32</span><span class="tok tok-symbol">.</span><span class="tok">HeapReAlloc</span><span class="tok tok-symbol">(</span>
                <span class="tok">self</span><span class="tok tok-symbol">.</span><span class="tok">heap_handle</span><span class="tok tok-symbol">.</span><span class="tok tok-symbol">?</span><span class="tok tok-symbol">,</span>
                <span class="tok">os</span><span class="tok tok-symbol">.</span><span class="tok">windows</span><span class="tok tok-symbol">.</span><span class="tok">HEAP_REALLOC_IN_PLACE_ONLY</span><span class="tok tok-symbol">,</span>
                <span class="tok tok-builtin">@intToPtr</span><span class="tok tok-symbol">(</span><span class="tok tok-symbol">*</span><span class="tok tok-type">c_void</span><span class="tok tok-symbol">,</span> <span class="tok">root_addr</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">,</span>
                <span class="tok">amt</span><span class="tok tok-symbol">,</span>
            <span class="tok tok-symbol">)</span> <span class="tok tok-kw">orelse</span> <span class="tok tok-kw">return</span> <span class="tok tok-kw">error</span><span class="tok tok-symbol">.</span><span class="tok">OutOfMemory</span><span class="tok tok-symbol">;</span>
            <span class="tok">assert</span><span class="tok tok-symbol">(</span><span class="tok">new_ptr</span> <span class="tok tok-symbol">==</span> <span class="tok tok-builtin">@intToPtr</span><span class="tok tok-symbol">(</span><span class="tok tok-symbol">*</span><span class="tok tok-type">c_void</span><span class="tok tok-symbol">,</span> <span class="tok">root_addr</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">;</span>
            <span class="tok tok-kw">const</span> <span class="tok">return_len</span> <span class="tok tok-symbol">=</span> <span class="tok">init</span><span class="tok tok-symbol">:</span> <span class="tok tok-symbol">{</span>
                <span class="tok tok-kw">if</span> <span class="tok tok-symbol">(</span><span class="tok">len_align</span> <span class="tok tok-symbol">==</span> <span class="tok tok-number">0</span><span class="tok tok-symbol">)</span> <span class="tok tok-kw">break</span> <span class="tok tok-symbol">:</span><span class="tok">init</span> <span class="tok">new_size</span><span class="tok tok-symbol">;</span>
                <span class="tok tok-kw">const</span> <span class="tok">full_len</span> <span class="tok tok-symbol">=</span> <span class="tok">os</span><span class="tok tok-symbol">.</span><span class="tok">windows</span><span class="tok tok-symbol">.</span><span class="tok">kernel32</span><span class="tok tok-symbol">.</span><span class="tok">HeapSize</span><span class="tok tok-symbol">(</span><span class="tok">self</span><span class="tok tok-symbol">.</span><span class="tok">heap_handle</span><span class="tok tok-symbol">.</span><span class="tok tok-symbol">?</span><span class="tok tok-symbol">,</span> <span class="tok tok-number">0</span><span class="tok tok-symbol">,</span> <span class="tok">new_ptr</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">;</span>
                <span class="tok">assert</span><span class="tok tok-symbol">(</span><span class="tok">full_len</span> <span class="tok tok-symbol">!=</span> <span class="tok">std</span><span class="tok tok-symbol">.</span><span class="tok">math</span><span class="tok tok-symbol">.</span><span class="tok">maxInt</span><span class="tok tok-symbol">(</span><span class="tok tok-type">usize</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">;</span>
                <span class="tok">assert</span><span class="tok tok-symbol">(</span><span class="tok">full_len</span> <span class="tok tok-symbol">&gt;=</span> <span class="tok">amt</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">;</span>
                <span class="tok tok-kw">break</span> <span class="tok tok-symbol">:</span><span class="tok">init</span> <span class="tok">mem</span><span class="tok tok-symbol">.</span><span class="tok">alignBackwardAnyAlign</span><span class="tok tok-symbol">(</span><span class="tok">full_len</span> <span class="tok tok-symbol">-</span> <span class="tok">align_offset</span><span class="tok tok-symbol">,</span> <span class="tok">len_align</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">;</span>
            <span class="tok tok-symbol">}</span><span class="tok tok-symbol">;</span>
            <span class="tok">getRecordPtr</span><span class="tok tok-symbol">(</span><span class="tok">buf</span><span class="tok tok-symbol">.</span><span class="tok">ptr</span><span class="tok tok-symbol">[</span><span class="tok tok-number">0</span><span class="tok tok-symbol">..</span><span class="tok">return_len</span><span class="tok tok-symbol">]</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">.*</span> <span class="tok tok-symbol">=</span> <span class="tok">root_addr</span><span class="tok tok-symbol">;</span>
            <span class="tok tok-kw">return</span> <span class="tok">return_len</span><span class="tok tok-symbol">;</span>
        <span class="tok tok-symbol">}</span>
    <span class="tok tok-symbol">}</span><span class="tok tok-symbol">,</span>
    <span class="tok tok-kw">else</span> <span class="tok tok-symbol">=&gt;</span> <span class="tok tok-builtin">@compileError</span><span class="tok tok-symbol">(</span><span class="tok tok-str">&quot;Unsupported OS&quot;</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">,</span>
<span class="tok tok-symbol">}</span></code></pre></div><div class="anal-decl"><a href="https://github.com/ziglang/zig/blob/master/lib/std/heap.zig#L743">src</a><pre><code class="zig"><span class="tok tok-kw">const</span> <span class="tok">ThreadSafeFixedBufferAllocator</span> <span class="tok tok-symbol">=</span> <span class="tok">blk</span><span class="tok tok-symbol">:</span> <span class="tok tok-symbol">{</span>
    <span class="tok tok-kw">if</span> <span class="tok tok-symbol">(</span><span class="tok">builtin</span><span class="tok tok-symbol">.</span><span class="tok">single_threaded</span><span class="tok tok-symbol">)</span> <span class="tok tok-symbol">{</span>
        <span class="tok tok-kw">break</span> <span class="tok tok-symbol">:</span><span class="tok">blk</span> <span class="tok">FixedBufferAllocator</span><span class="tok tok-symbol">;</span>
    <span class="tok tok-symbol">}</span> <span class="tok tok-kw">else</span> <span class="tok tok-symbol">{</span>
        // lock free
        <span class="tok tok-kw">break</span> <span class="tok tok-symbol">:</span><span class="tok">blk</span> <span class="tok tok-kw">struct</span> <span class="tok tok-symbol">{</span>
            <span class="tok">allocator</span><span class="tok tok-symbol">:</span> <span class="tok">Allocator</span><span class="tok tok-symbol">,</span>
            <span class="tok">end_index</span><span class="tok tok-symbol">:</span> <span class="tok tok-type">usize</span><span class="tok tok-symbol">,</span>
            <span class="tok">buffer</span><span class="tok tok-symbol">:</span> <span class="tok tok-symbol">[</span><span class="tok tok-symbol">]</span><span class="tok tok-type">u8</span><span class="tok tok-symbol">,</span>

            <span class="tok tok-kw">pub</span> <span class="tok tok-kw">fn</span> <span class="tok tok-fn">init</span><span class="tok tok-symbol">(</span><span class="tok">buffer</span><span class="tok tok-symbol">:</span> <span class="tok tok-symbol">[</span><span class="tok tok-symbol">]</span><span class="tok tok-type">u8</span><span class="tok tok-symbol">)</span> <span class="tok">ThreadSafeFixedBufferAllocator</span> <span class="tok tok-symbol">{</span>
                <span class="tok tok-kw">return</span> <span class="tok">ThreadSafeFixedBufferAllocator</span><span class="tok tok-symbol">{</span>
                    <span class="tok tok-symbol">.</span><span class="tok">allocator</span> <span class="tok tok-symbol">=</span> <span class="tok">Allocator</span><span class="tok tok-symbol">{</span>
                        <span class="tok tok-symbol">.</span><span class="tok">allocFn</span> <span class="tok tok-symbol">=</span> <span class="tok">alloc</span><span class="tok tok-symbol">,</span>
                        <span class="tok tok-symbol">.</span><span class="tok">resizeFn</span> <span class="tok tok-symbol">=</span> <span class="tok">Allocator</span><span class="tok tok-symbol">.</span><span class="tok">noResize</span><span class="tok tok-symbol">,</span>
                    <span class="tok tok-symbol">}</span><span class="tok tok-symbol">,</span>
                    <span class="tok tok-symbol">.</span><span class="tok">buffer</span> <span class="tok tok-symbol">=</span> <span class="tok">buffer</span><span class="tok tok-symbol">,</span>
                    <span class="tok tok-symbol">.</span><span class="tok">end_index</span> <span class="tok tok-symbol">=</span> <span class="tok tok-number">0</span><span class="tok tok-symbol">,</span>
                <span class="tok tok-symbol">}</span><span class="tok tok-symbol">;</span>
            <span class="tok tok-symbol">}</span>

            <span class="tok tok-kw">fn</span> <span class="tok tok-fn">alloc</span><span class="tok tok-symbol">(</span><span class="tok">allocator</span><span class="tok tok-symbol">:</span> <span class="tok tok-symbol">*</span><span class="tok">Allocator</span><span class="tok tok-symbol">,</span> <span class="tok">n</span><span class="tok tok-symbol">:</span> <span class="tok tok-type">usize</span><span class="tok tok-symbol">,</span> <span class="tok">ptr_align</span><span class="tok tok-symbol">:</span> <span class="tok tok-type">u29</span><span class="tok tok-symbol">,</span> <span class="tok">len_align</span><span class="tok tok-symbol">:</span> <span class="tok tok-type">u29</span><span class="tok tok-symbol">,</span> <span class="tok">ra</span><span class="tok tok-symbol">:</span> <span class="tok tok-type">usize</span><span class="tok tok-symbol">)</span> <span class="tok tok-symbol">!</span><span class="tok tok-symbol">[</span><span class="tok tok-symbol">]</span><span class="tok tok-type">u8</span> <span class="tok tok-symbol">{</span>
                <span class="tok tok-kw">const</span> <span class="tok">self</span> <span class="tok tok-symbol">=</span> <span class="tok tok-builtin">@fieldParentPtr</span><span class="tok tok-symbol">(</span><span class="tok">ThreadSafeFixedBufferAllocator</span><span class="tok tok-symbol">,</span> <span class="tok tok-str">&quot;allocator&quot;</span><span class="tok tok-symbol">,</span> <span class="tok">allocator</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">;</span>
                <span class="tok tok-kw">var</span> <span class="tok">end_index</span> <span class="tok tok-symbol">=</span> <span class="tok tok-builtin">@atomicLoad</span><span class="tok tok-symbol">(</span><span class="tok tok-type">usize</span><span class="tok tok-symbol">,</span> <span class="tok tok-symbol">&amp;</span><span class="tok">self</span><span class="tok tok-symbol">.</span><span class="tok">end_index</span><span class="tok tok-symbol">,</span> <span class="tok">builtin</span><span class="tok tok-symbol">.</span><span class="tok">AtomicOrder</span><span class="tok tok-symbol">.</span><span class="tok">SeqCst</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">;</span>
                <span class="tok tok-kw">while</span> <span class="tok tok-symbol">(</span><span class="tok tok-null">true</span><span class="tok tok-symbol">)</span> <span class="tok tok-symbol">{</span>
                    <span class="tok tok-kw">const</span> <span class="tok">addr</span> <span class="tok tok-symbol">=</span> <span class="tok tok-builtin">@ptrToInt</span><span class="tok tok-symbol">(</span><span class="tok">self</span><span class="tok tok-symbol">.</span><span class="tok">buffer</span><span class="tok tok-symbol">.</span><span class="tok">ptr</span><span class="tok tok-symbol">)</span> <span class="tok tok-symbol">+</span> <span class="tok">end_index</span><span class="tok tok-symbol">;</span>
                    <span class="tok tok-kw">const</span> <span class="tok">adjusted_addr</span> <span class="tok tok-symbol">=</span> <span class="tok">mem</span><span class="tok tok-symbol">.</span><span class="tok">alignForward</span><span class="tok tok-symbol">(</span><span class="tok">addr</span><span class="tok tok-symbol">,</span> <span class="tok">ptr_align</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">;</span>
                    <span class="tok tok-kw">const</span> <span class="tok">adjusted_index</span> <span class="tok tok-symbol">=</span> <span class="tok">end_index</span> <span class="tok tok-symbol">+</span> <span class="tok tok-symbol">(</span><span class="tok">adjusted_addr</span> <span class="tok tok-symbol">-</span> <span class="tok">addr</span><span class="tok tok-symbol">)</span><span class="tok tok-symbol">;</span>
                    <span class="tok tok-kw">const</span> <span class="tok">new_end_index</span> <span class="tok tok-symbol">=</span> <span class="tok">adjusted_index</span> <span class="tok tok-symbol">+</span> <span class="tok">n</span><span class="tok tok-symbol">;</span>
                    <span class="tok tok-kw">if</span> <span class="tok tok-symbol">(</span><span class="tok">new_end_index</span> <span class="tok tok-symbol">&gt;</span> <span class="tok">self</span><span class="tok tok-symbol">.</span><span class="tok">buffer</span><span class="tok tok-symbol">.</span><span class="tok">len</span><span class="tok tok-symbol">)</span> <span class="tok tok-symbol">{</span>
                        <span class="tok tok-kw">return</span> <span class="tok tok-kw">error</span><span class="tok tok-symbol">.</span><span class="tok">OutOfMemory</span><span class="tok tok-symbol">;</span>
                    <span class="tok tok-symbol">}</span>
                    <span class="tok">end_index</span> <span class="tok tok-symbol">=</span> <span class="tok tok-builtin">@cmpxchgWeak</span><span class="tok tok-symbol">(</span><span class="tok tok-type">usize</span><span class="tok tok-symbol">,</span> <span class="tok tok-symbol">&amp;</span><span class="tok">self</span><span class="tok tok-symbol">.</span><span class="tok">end_index</span><span class="tok tok-symbol">,</span> <span class="tok">end_index</span><span class="tok tok-symbol">,</span> <span class="tok">new_end_index</span><span class="tok tok-symbol">,</span> <span class="tok">builtin</span><span class="tok tok-symbol">.</span><span class="tok">AtomicOrder</span><span class="tok tok-symbol">.</span><span class="tok">SeqCst</span><span class="tok tok-symbol">,</span> <span class="tok">builtin</span><span class="tok tok-symbol">.</span><span class="tok">AtomicOrder</span><span class="tok tok-symbol">.</span><span class="tok">SeqCst</span><span class="tok tok-symbol">)</span> <span class="tok tok-kw">orelse</span> <span class="tok tok-kw">return</span> <span class="tok">self</span><span class="tok tok-symbol">.</span><span class="tok">buffer</span><span class="tok tok-symbol">[</span><span class="tok">adjusted_index</span><span class="tok tok-symbol">..</span><span class="tok">new_end_index</span><span class="tok tok-symbol">]</span><span class="tok tok-symbol">;</span>
                <span class="tok tok-symbol">}</span>
            <span class="tok tok-symbol">}</span>

            <span class="tok tok-kw">pub</span> <span class="tok tok-kw">fn</span> <span class="tok tok-fn">reset</span><span class="tok tok-symbol">(</span><span class="tok">self</span><span class="tok tok-symbol">:</span> <span class="tok tok-symbol">*</span><span class="tok">ThreadSafeFixedBufferAllocator</span><span class="tok tok-symbol">)</span> <span class="tok tok-type">void</span> <span class="tok tok-symbol">{</span>
                <span class="tok">self</span><span class="tok tok-symbol">.</span><span class="tok">end_index</span> <span class="tok tok-symbol">=</span> <span class="tok tok-number">0</span><span class="tok tok-symbol">;</span>
            <span class="tok tok-symbol">}</span>
        <span class="tok tok-symbol">}</span><span class="tok tok-symbol">;</span>
    <span class="tok tok-symbol">}</span>
<span class="tok tok-symbol">}</span></code></pre></div></div></html>